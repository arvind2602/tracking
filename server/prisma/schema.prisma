generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model organiation {
  id        String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  createdAt DateTime   @default(now())
  updatedAt DateTime?  @updatedAt
  Site      Site[]
  employees employee[]
  projects  projects[]
}

model employee {
  id            String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firstName     String
  lastName      String
  email         String      @unique
  position      String
  role          role
  createdAt     DateTime    @default(now())
  updatedAt     DateTime?   @updatedAt
  is_archived   Boolean     @default(false)
  organiationId String      @db.Uuid
  password      String
  lastDeviceId  String?
  TimeLog       TimeLog[]
  comments      comment[]
  organiation   organiation @relation(fields: [organiationId], references: [id])
}

model projects {
  id            String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  description   String
  startDate     DateTime
  createdAt     DateTime    @default(now())
  updatedAt     DateTime?   @updatedAt
  organiationId String      @db.Uuid
  is_archived   Boolean     @default(false)
  endDate       DateTime?
  organiation   organiation @relation(fields: [organiationId], references: [id])
  task          task[]
}

model task {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  description String
  status      String
  createdBy   String
  assignedTo  String?
  assigned_at DateTime?
  points      Float
  createdAt   DateTime  @default(now())
  updatedAt   DateTime? @updatedAt
  projectId   String    @db.Uuid
  dueDate     DateTime?
  order       Int       @default(0)
  priority    Priority  @default(MEDIUM)
  completedAt DateTime?
  comments    comment[]
  project     projects  @relation(fields: [projectId], references: [id])

  parent   task?   @relation("SubTasks", fields: [parentId], references: [id])
  parentId String? @db.Uuid
  subtasks task[]  @relation("SubTasks")

  @@index([projectId, status], map: "idx_task_project_status")
  @@index([assignedTo, status, updatedAt(sort: Desc)], map: "idx_task_assigned_status")
  @@index([projectId], map: "idx_task_project")
  @@index([projectId, order, createdAt(sort: Desc)], map: "idx_task_project_order")
  @@index([parentId], map: "idx_task_parent")
}

model comment {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  content   String
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
  taskId    String    @db.Uuid
  authorId  String    @db.Uuid
  author    employee  @relation(fields: [authorId], references: [id])
  task      task      @relation(fields: [taskId], references: [id])

  @@index([authorId], map: "idx_comment_author")
  @@index([taskId, createdAt(sort: Desc)], map: "idx_comment_task")
}

model Site {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name           String
  description    String?
  latitude       Float
  longitude      Float
  organizationId String      @db.Uuid
  createdAt      DateTime    @default(now())
  updatedAt      DateTime?
  organiation    organiation @relation(fields: [organizationId], references: [id])
}

model TimeLog {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  employeeId String    @db.Uuid
  checkIn    DateTime  @default(now())
  checkOut   DateTime?
  type       LogType   @default(WORK)
  reason     String?
  latitude   Float?
  longitude  Float?
  deviceId   String?
  deviceType String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime?
  employee   employee  @relation(fields: [employeeId], references: [id])
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum role {
  ADMIN
  USER
}

enum LogType {
  WORK
  LUNCH
  BREAK
  WASHROOM
  PERSONAL_EMERGENCY
  HOME
  OTHER
}
